<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="multimedia/favicon.png">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.iconify.design/3/3.1.1/iconify.min.js"></script>
  <style>
    @font-face {
        font-family: 'Moderat';
        src: url('font/Moderat-Bold.ttf') format('truetype');
        font-weight: 700;
        font-style: normal;
    }
    @font-face {
        font-family: 'Moderat';
        src: url('font/Moderat-Medium.ttf') format('truetype');
        font-weight: 500;
        font-style: normal;
    }
    @font-face {
        font-family: 'Moderat';
        src: url('font/Moderat-Regular.ttf') format('truetype');
        font-weight: 400;
        font-style: normal;
    }
    @font-face {
        font-family: 'Moderat';
        src: url('font/Moderat-Light.ttf') format('truetype');
        font-weight: 300;
        font-style: normal;
    }
    * {
      font-family: 'Moderat', sans-serif;
      font-weight: 400;
      font-style: normal;
      user-select: none;
      box-sizing: border-box;
    }
    :root {
      --green: #83DC5A;
      --dark-blue: #203855;
      --blue: #1D54C0;
      --light-blue: #A0C3EA;
      --extra-light-blue: #EDF5FF;
    }
    body {
        cursor: none;
        background-color: black;
        overflow: hidden; 
    }
    .hidden {
        display: none !important;
    }
    
    #lyric-text {
      /* Se eliminó text-shadow como solicitaste */
      will-change: contents; 
    }
    
    #loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: black;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 2rem;
      z-index: 50;
    }
  </style>
  <title>Tiempos | ibblaverdad</title>
</head>
<body class="bg-black">
  
  <div id="loading-screen">Cargando recursos...</div>

  <div id="slider-container" class="h-screen w-screen bg-black relative">
    <div id="image-slide-container" class="h-full w-full flex items-center justify-center hidden">
      <img id="slider-image" src="" alt="Slider" class="max-h-full max-w-full object-contain">
    </div>
    
    <div id="song-slide-container" class="h-full w-full relative hidden">
      <video id="song-video" class="absolute top-0 left-0 w-full h-full object-cover" loop muted playsinline preload="auto"></video>
      <audio id="song-audio" preload="auto"></audio>
      
      <div class="absolute inset-0 flex justify-center items-center z-10 px-16 lg:px-24">
        <p id="lyric-text" class="text-white text-5xl lg:text-6xl font-bold bg-black px-6 py-3 rounded-lg text-center uppercase transition-all duration-200"></p>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Configuración de Slides (con final.png agregado)
      const slides = [
        { type: 'image', src: 'multimedia/hola.png' },
        {
          type: 'song',
          mp3: 'multimedia/Yo le alabo.mp3',
          txt: 'multimedia/Yo le alabo.txt',
          video: 'multimedia/fondo5.mp4',
          lyrics: []
        },
        {
          type: 'song',
          mp3: 'multimedia/Jesús es mi salvador.mp3',
          txt: 'multimedia/Jesús es mi salvador.txt',
          video: 'multimedia/fondo6.mp4',
          lyrics: []
        },
        { type: 'image', src: 'multimedia/bye.png' },
        { type: 'image', src: 'multimedia/final.png' } // AGREGADO
      ];

      // Esto se calcula solo, ahora maxIndex será 4
      const maxIndex = slides.length - 1;
      let currentIndex = 0;
      let firstInteraction = true;
      let currentLyricLine = null; 
      
      const imageSlideContainer = document.getElementById('image-slide-container');
      const sliderImage = document.getElementById('slider-image');
      const songSlideContainer = document.getElementById('song-slide-container');
      const songVideo = document.getElementById('song-video');
      const songAudio = document.getElementById('song-audio');
      const lyricText = document.getElementById('lyric-text');
      const loadingScreen = document.getElementById('loading-screen');
      const bodyElement = document.documentElement;

      function parseLyrics(text) {
        if (!text) return [];
        const lines = text.split('\n').slice(1);
        const lyrics = [];
        const regex = /\[(\d{2}):(\d{2})\.(\d{2})\](.*)/;
        
        for (const line of lines) {
          const match = line.match(regex);
          if (match) {
            const minutes = parseInt(match[1], 10);
            const seconds = parseInt(match[2], 10);
            const hundredths = parseInt(match[3], 10);
            const textContent = match[4].trim();
            
            if (textContent) { 
              const time = (minutes * 60) + seconds + (hundredths / 100);
              lyrics.push({ time, text: textContent });
            }
          }
        }
        return lyrics;
      }

      async function loadAllResources() {
        const promises = slides.map(async (slide, index) => {
          if (slide.type === 'song') {
            try {
              const safeTxtUrl = encodeURI(slide.txt);
              const response = await fetch(safeTxtUrl);
              if (!response.ok) throw new Error(`No se encontró ${safeTxtUrl}`);
              const text = await response.text();
              slides[index].lyrics = parseLyrics(text);
              
              const tempAudio = new Audio();
              tempAudio.src = encodeURI(slide.mp3);
              tempAudio.preload = 'metadata'; 

            } catch (err) {
              console.error(`Error cargando recurso (revise nombre de archivo): ${slide.txt}`, err);
              slides[index].lyrics = [{time: 0, text: ""}]; 
            }
          } else if (slide.type === 'image') {
             const img = new Image();
             img.src = encodeURI(slide.src);
          }
        });

        await Promise.all(promises);
      }

      function goFullScreen() {
        if (document.fullscreenElement) return;
        if (bodyElement.requestFullscreen) bodyElement.requestFullscreen().catch(err => console.log(err));
      }

      function exitFullScreen() {
        if (!document.fullscreenElement) return;
        if (document.exitFullscreen) document.exitFullscreen();
      }

      function renderSlide(index) {
        const slide = slides[index];
        
        songAudio.pause();
        songVideo.pause();

        if (slide.type === 'image') {
          imageSlideContainer.classList.remove('hidden');
          songSlideContainer.classList.add('hidden');
          sliderImage.src = encodeURI(slide.src);
        } else if (slide.type === 'song') {
          songSlideContainer.classList.remove('hidden');
          imageSlideContainer.classList.add('hidden');
          
          songVideo.src = encodeURI(slide.video);
          songAudio.src = encodeURI(slide.mp3);
          songAudio.currentTime = 0;
          
          lyricText.classList.add('hidden');
          lyricText.textContent = "";
          currentLyricLine = null;
          
          const playVideoPromise = songVideo.play();
          if (playVideoPromise !== undefined) {
            playVideoPromise.catch(error => {
                console.log("Auto-play video prevenido", error);
            });
          }

          const playAudioPromise = songAudio.play();
          if (playAudioPromise !== undefined) {
            playAudioPromise.catch(error => {
                console.log("Auto-play audio prevenido", error);
            });
          }
        }
      }

      function updateLyrics() {
        if (songAudio.paused) return;

        const currentTime = songAudio.currentTime;
        const currentSlide = slides[currentIndex];

        if (currentSlide.type !== 'song' || !currentSlide.lyrics.length) return;
        
        const lyrics = currentSlide.lyrics;
        let activeLyric = null;

        for (let i = lyrics.length - 1; i >= 0; i--) {
          if (currentTime >= lyrics[i].time) {
            activeLyric = lyrics[i];
            break;
          }
        }

        if (activeLyric) {
          if (currentTime - activeLyric.time < 7.0) {
            if (currentLyricLine !== activeLyric.text) {
              lyricText.textContent = activeLyric.text;
              lyricText.classList.remove('hidden');
              currentLyricLine = activeLyric.text;
            }
          } else {
            if (currentLyricLine !== null) {
              lyricText.classList.add('hidden');
              currentLyricLine = null;
            }
          }
        } else {
          if (currentLyricLine !== null) {
            lyricText.classList.add('hidden');
            currentLyricLine = null;
          }
        }
      }

      async function initializeApp() {
        try {
            await loadAllResources();
            loadingScreen.classList.add('hidden');
            
            songAudio.addEventListener('timeupdate', updateLyrics);
            
            songAudio.addEventListener('ended', () => {
              lyricText.classList.add('hidden');
              currentLyricLine = null;
            });

            document.addEventListener('keydown', (e) => {
              if (firstInteraction) {
                goFullScreen();
                firstInteraction = false;
              }
              
              const currentSlide = slides[currentIndex];
              
              switch (e.key) {
                case 'ArrowRight':
                  currentIndex = Math.min(currentIndex + 1, maxIndex);
                  renderSlide(currentIndex);
                  break;
                case 'ArrowLeft':
                  currentIndex = Math.max(currentIndex - 1, 0);
                  renderSlide(currentIndex);
                  break;
                case 'ArrowUp':
                  goFullScreen();
                  break;
                case 'ArrowDown':
                  exitFullScreen();
                  break;
                case 'Enter':
                  if (currentSlide.type === 'song') {
                    if (songAudio.paused) {
                      songAudio.play();
                      songVideo.play();
                    } else {
                      songAudio.pause();
                      songVideo.pause();
                    }
                  }
                  break;
              }
            });

            document.body.addEventListener('click', () => {
              if (firstInteraction) {
                  goFullScreen();
                  firstInteraction = false;
              }
            });

            renderSlide(currentIndex);

        } catch (e) {
            console.error("Error fatal iniciando la app", e);
            loadingScreen.innerText = "Error. Revisa consola (F12).";
        }
      }

      initializeApp();
    });
  </script>
</body>
</html>